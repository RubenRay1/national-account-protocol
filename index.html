<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>National Account Protocol - Secure Portal</title>
  <script src="https://unpkg.com/aws-amplify@5.3.12/dist/aws-amplify.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Sage UI test', Roboto, sans-serif;
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
      color: #f80505;
      min-height: 100vh;
    }
    .header {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      color: white;
      padding: 2rem 0;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 600; }
    .header p { font-size: 1.1rem; opacity: 0.9; }

    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .search-section {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 1.25rem;
    }

    .search-box {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 1rem;
      transition: border-color 0.3s ease;
    }
    .search-box:focus {
      outline: none;
      border-color: #2B73B5;
      box-shadow: 0 0 0 3px rgba(43,115,181,0.1);
    }

    .stats { text-align:center; color:#666; margin-bottom: 1rem; font-weight: 500; }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .records-grid { display: grid; gap: 1.5rem; }

    .record-card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.2);
      cursor: pointer;
    }
    .record-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.15); }

    .record-header {
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .expand-icon { font-size: 1.5rem; transition: transform 0.3s ease; }
    .record-card.expanded .expand-icon { transform: rotate(180deg); }

    .record-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .record-card.expanded .record-content { padding: 1.5rem; max-height: none; }

    .field-grid {
    display: flex;
    flex-direction: column;
    }

    .field-row {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 0.75rem;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f0f0f0;
    }

    .field-label {
    font-weight: 600;
    color: #1F4788;
    font-size: 0.9rem;
    }

    .field-value {
    word-break: break-word;
    line-height: 1.5;
    white-space: pre-wrap;
    }

    .no-results {
      text-align: center;
      padding: 3rem;
      color: #666;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .load-more-wrap { display:flex; justify-content:center; margin: 1.25rem 0 2rem 0; }
    .load-more-btn {
      background: #F47920;
      color: white;
      border: none;
      padding: 0.9rem 1.4rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }
    .load-more-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .bms-badge {
      display: inline-block;
      background: #F47920;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 1rem;
    }

    .auth-container {
      display:flex;
      justify-content:center;
      align-items:center;
      min-height: 100vh;
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
    }
    .auth-card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      text-align:center;
      max-width: 400px;
      width: 90%;
    }
    .auth-button {
      background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 1rem;
    }
    .auth-button:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(31,71,136,0.3); }

    .user-info {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .logout-btn {
      background: #F47920;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .skeleton-card {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .sk-line {
      height: 14px;
      border-radius: 8px;
      margin: 10px 0;
      background: linear-gradient(90deg, #ececec, #f5f5f5, #ececec);
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
    }
    .sk-line.w40 { width: 40%; }
    .sk-line.w60 { width: 60%; }
    .sk-line.w80 { width: 80%; }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .hidden { display:none; }
  </style>
</head>
<body>
  <div id="authScreen" class="auth-container">
    <div class="auth-card">
      <h1>National Account Protocol <span class="bms-badge">BMS</span></h1>
      <p style="margin: 1rem 0; color: #666;">Secure access to customer data</p>
      <button id="loginBtn" class="auth-button">Sign In with OKTA</button>
    </div>
  </div>

  <div id="mainApp" class="hidden">
    <div class="header">
      <div class="user-info">
        <span id="userEmail">Loading...</span>
        <button id="logoutBtn" class="logout-btn">Sign Out</button>
      </div>
      <h1> National Account Protocol <span class="bms-badge">BMS CAT</span></h1>
      <p>National Account Protocol Search Portal</p>
    </div>

    <div class="container">
      <div class="search-section">
        <input type="text" id="searchBox" class="search-box" placeholder="Search (Company)..." />
        <div id="stats" class="stats">Loading data...</div>
      </div>

      <div id="content" class="loading">Loading records from DynamoDB...</div>

      <div class="load-more-wrap">
        <button id="loadMoreBtn" class="load-more-btn hidden">Load more</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // CONFIG
    // ==============================
    const READ_API_BASE_URL = "https://joggcs6iisqlsyjjxxebho7e540yajvo.lambda-url.us-east-1.on.aws/";
    const PAGE_SIZE = 50;

    // ✅ EXACT Excel column order (left → right), rendered top → bottom in the app
    const FIELD_ORDER = [
      "Company (Full Legal Name)",
      "Industry",
      "Customer Corporate Office Address",
      "Customer Contacts",
      "BMS Cat Account Manager",
      "Agreement Type\n(RSA, MSA, Handshake)",
      "Brands",
      "Local Marketing Direction",
      "Pricing/Rate Schedule\n***YOU MUST SPECIFY THE YEAR AS THERE ARE DIFFERENT RATE SCHEDULES WITH THE SAME NAME, BUT DIFFERENT YEAR!",
      "Rebate/Discount/Fee & General Agreement Details",
      "Reason Why Customer is not under Preferred 2024 Rate Schedule (If Customer is currently under Preferred 2024 Rate Schedule, list \"N/A\")",
      "National Adjuster",
      "Chase Instructions",
      "Key Differences",
      "WHO should the Project Updates be sent to?",
      "WHAT should be included in the Project Updates?",
      "WHEN should the Project Updates be sent?",
      "WHERE should the Project Updates be sent?",
      "WHO should provide the Work Authorization?",
      "WHAT type of Work Authorization should be obtained?",
      "WHEN should the Work Authorization be obtained?",
      "WHERE should the Work Authorization be sent?",
      "WHO should the Scope of Work/Estimate be sent to?",
      "WHAT should be included in the Scope of Work/Estimate?",
      "WHEN should the Scope of Work/Estimate be sent?",
      "WHERE should the Scope of Work/Estimate be sent?",
      "WHO should sign our SOWC/COC/Work Complete Form?",
      "WHAT type of SOWC/COC/Work Complete Form should be obtained?",
      "WHEN should the SOWC/COC/Work Complete Form be obtained?",
      "WHERE should the SOWC/COC/Work Complete Form be sent?",
      "WHO should create the Invoice Packet?",
      "WHAT should be included when the Invoice Packet is created?",
      "WHEN should the Invoice Packet be created?",
      "WHERE should the Invoice Packet be sent once it's created?",
      "WHO should send the completed Invoice Packet to the Customer?",
      "WHAT should be included with the completed Invoice Packet to the Customer?",
      "WHEN should the completed Invoice Packet be sent to the Customer?",
      "WHERE should the completed Invoice Packet be sent?",
      "Payment Terms",
      "WHO should attempt initial collection?",
      "WHAT should be sent to attempt initial collection?",
      "WHEN should the initial collection take place?",
      "WHERE should the initial collection be directed to?",
      "WHO should attempt secondary collection?",
      "WHAT should be sent to attempt secondary collection?",
      "WHEN should the secondary collection take place?",
      "WHERE should the secondary collection be directed to?",
      "WHO should attempt final collection?",
      "WHAT should be sent to attempt final collection?",
      "WHEN should the final collection take place?",
      "WHERE should the final collection be directed to?",
      "Specific Account Protocols"
    ];

    // ==============================
    // STATE
    // ==============================
    let allData = [];
    let nextKey = null;
    let lastQuery = "";
    let isLoading = false;
    let totalCount = null;
    let matchedTotal = null;

    // ==============================
    // AUTH (unchanged)
    // ==============================
    async function checkAuthState() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");

        if (code) {
          showMainApp();
          document.getElementById("userEmail").textContent = "Authenticated User";
          window.history.replaceState({}, document.title, window.location.pathname);
        } else {
          const token = localStorage.getItem("cognitoToken");
          if (token) {
            showMainApp();
            document.getElementById("userEmail").textContent = "Authenticated User";
          } else {
            showAuthScreen();
          }
        }
      } catch (e) {
        showAuthScreen();
      }
    }

    function showAuthScreen() {
      document.getElementById("authScreen").classList.remove("hidden");
      document.getElementById("mainApp").classList.add("hidden");
      localStorage.removeItem("cognitoToken");
    }

    function showMainApp() {
      document.getElementById("authScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      localStorage.setItem("cognitoToken", "authenticated");
      loadFirstPage();
    }

    document.getElementById("loginBtn").addEventListener("click", () => {
      window.location.href =
        "https://national-account-protocol.auth.us-east-1.amazoncognito.com/oauth2/authorize" +
        "?identity_provider=OktaNAP" +
        "&client_id=7si5kk2t9t24nrtgkumc2n6ops" +
        "&response_type=code" +
        "&scope=email+openid+profile" +
        "&redirect_uri=" + encodeURIComponent(window.location.origin + "/");
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      window.location.href =
        "https://national-account-protocol.auth.us-east-1.amazoncognito.com/logout" +
        "?client_id=7si5kk2t9t24nrtgkumc2n6ops" +
        "&logout_uri=" + encodeURIComponent(window.location.origin + "/");
    });

    // ==============================
    // HELPERS
    // ==============================

    // ✅ Normalizes keys so we match weird JSON keys like "Brands         " or extra newlines
    function normalizeKey(s) {
      return String(s ?? "")
        .replace(/\r\n/g, "\n")
        .replace(/\s+/g, " ")   // collapse whitespace
        .replace(/\s*\n\s*/g, "\n") // keep \n but remove spaces around it
        .trim();
    }

    function buildKeyMap(record) {
      const map = new Map(); // normalized -> original
      Object.keys(record || {}).forEach(k => {
        map.set(normalizeKey(k), k);
      });
      return map;
    }

    function getCompanyTitle(record) {
      // Prefer "Company" (short) then fall back to "Company (Full Legal Name)"
      return (
        record.Company ||
        record.company ||
        record["Company (Full Legal Name)"] ||
        "Company"
      );
    }

    function setLoading(message) {
      document.getElementById("content").innerHTML = `<div class="loading">${message}</div>`;
    }

    function renderSkeleton() {
      const content = document.getElementById("content");
      content.innerHTML = `
        <div class="records-grid">
          ${Array.from({ length: 6 }).map(() => `
            <div class="skeleton-card">
              <div class="sk-line w60"></div>
              <div class="sk-line w80"></div>
              <div class="sk-line w40"></div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function showLoadMoreButton(show) {
      const btn = document.getElementById("loadMoreBtn");
      if (show) btn.classList.remove("hidden");
      else btn.classList.add("hidden");
    }

    function setLoadMoreLoading(loading) {
      const btn = document.getElementById("loadMoreBtn");
      btn.disabled = loading;
      btn.textContent = loading ? "Loading..." : "Load more";
    }

    function updateStatsRange() {
    const stats = document.getElementById("stats");
    const loaded = allData.length;

    // if searching and API returned match count
    if (lastQuery && typeof matchedTotal === "number") {
        const start = loaded > 0 ? 1 : 0;
        const end = loaded;
        stats.textContent = `Showing ${start}–${end} of ${matchedTotal} matches`;
        return;
    }

    // default
    if (typeof totalCount === "number") {
        const start = loaded > 0 ? 1 : 0;
        const end = loaded;
        stats.textContent = `Showing ${start}–${end} of ~${totalCount} records`;
    } else {
        stats.textContent = `Loaded ${loaded} records`;
    }
    }

    function updateStats() {
      updateStatsRange();
    }

    // ✅ Keep labels as-is (Excel headers), just clean spacing
    function prettyLabel(label) {
      return normalizeKey(label);
    }

    function toggleCard(header) {
      const card = header.parentElement;
      card.classList.toggle("expanded");
    }

    // ==============================
    // RENDER
    // ==============================
    function displayRecords(records) {
      const content = document.getElementById("content");

      if (!records || records.length === 0) {
        content.innerHTML = `<div class="no-results">No records found.</div>`;
        return;
      }

      // ✅ sort by the same title field the cards use
      records = [...records].sort((a, b) =>
        String(getCompanyTitle(a)).localeCompare(String(getCompanyTitle(b)))
      );

      const grid = document.createElement("div");
      grid.className = "records-grid";

      records.forEach((record, index) => {
        const card = document.createElement("div");
        card.className = "record-card";

        const title = getCompanyTitle(record);

        // Build a map so FIELD_ORDER matches record keys even if spacing/newlines differ
        const keyMap = buildKeyMap(record);

        // ✅ Prevent duplicates in the body (the title already shows these)
        const excludedNormalizedKeys = new Set([
          normalizeKey("Company"),
          normalizeKey("company")
        ]);

        let fieldsHtml = "";

        // ✅ Render strictly in Excel order
        FIELD_ORDER.forEach(label => {
          const normalizedLabel = normalizeKey(label);
          const originalKey = keyMap.get(normalizedLabel);

          if (!originalKey) return; // field not present in this record

          if (excludedNormalizedKeys.has(normalizedLabel)) return;

          const value = record[originalKey];
          if (value === null || value === undefined) return;

          const str = Array.isArray(value) ? value.join(", ") : String(value);
          const normalizedValue = str.trim().toLowerCase();

          if (
            normalizedValue === "" ||
            normalizedValue === "n/a" ||
            normalizedValue === "na" ||
            normalizedValue === "n//a"
          ) {
            return;
          }

          fieldsHtml += `
            <div class="field">
              <div class="field-label">${prettyLabel(label)}</div>
              <div class="field-value">${str}</div>
            </div>
          `;
        });

        card.innerHTML = `
          <div class="record-header" onclick="toggleCard(this)">
            ${title}
            <span class="expand-icon">▼</span>
          </div>
          <div class="record-content">
            <div class="field-grid">${fieldsHtml}</div>
          </div>
        `;

        grid.appendChild(card);
      });

      content.innerHTML = "";
      content.appendChild(grid);
    }

    // ==============================
    // API CALL (server-side paging)
    // ==============================
    async function fetchPage({ query, reset }) {
      if (isLoading) return;
      isLoading = true;

      try {
        if (reset) {
          allData = [];
          nextKey = null;
          matchedTotal = null;
          showLoadMoreButton(false);
          renderSkeleton();
        }

        const params = new URLSearchParams();
        if (query) params.set("q", query);
        params.set("limit", String(PAGE_SIZE));
        if (nextKey) params.set("lastKey", JSON.stringify(nextKey));

        const url = `${READ_API_BASE_URL}?${params.toString()}`;

        const res = await fetch(url, { method: "GET", mode: "cors" });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status} ${res.statusText} - ${text}`);
        }

        const payload = await res.json();
        matchedTotal = (typeof payload.matchedTotal === "number") ? payload.matchedTotal : null;

        const items = Array.isArray(payload.items) ? payload.items : [];
        nextKey = payload.nextKey || null;

        if (typeof payload.total === "number") totalCount = payload.total;

        allData = allData.concat(items);
        displayRecords(allData);
        updateStats();

        if (payload.mode === "exact_record") {
          showLoadMoreButton(false);
        } else {
          showLoadMoreButton(!!nextKey);
        }
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("content").innerHTML =
          `<div class="no-results">Error loading data: ${err.message}</div>`;
        showLoadMoreButton(false);
      } finally {
        isLoading = false;
        setLoadMoreLoading(false);
      }
    }

    // ==============================
    // WIRES
    // ==============================
    function loadFirstPage() {
      lastQuery = "";
      fetchPage({ query: "", reset: true });
    }

    let searchTimer = null;

    document.getElementById("searchBox").addEventListener("input", (e) => {
      lastQuery = e.target.value.trim();

      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        setLoadMoreLoading(false);
        fetchPage({ query: lastQuery, reset: true });
      }, 250);
    });

    document.getElementById("loadMoreBtn").addEventListener("click", () => {
      setLoadMoreLoading(true);
      fetchPage({ query: lastQuery, reset: false });
    });

    checkAuthState();
  </script>
</body>
</html>
