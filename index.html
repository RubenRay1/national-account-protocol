<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMS Customer Lookup - Secure Portal</title>
    <script src="https://unpkg.com/aws-amplify@5.3.12/dist/aws-amplify.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Sage UI test', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
            color: #f80505;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 2rem 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .search-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .search-box {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #2B73B5;
            box-shadow: 0 0 0 3px rgba(43, 115, 181, 0.1);
        }
        
        .stats {
            text-align: center;
            color: #666;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .records-grid {
            display: grid;
            gap: 1.5rem;
        }
        
        .record-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }
        
        .record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        .record-header {
            background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
            color: white;
            padding: 1.5rem;
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .expand-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .record-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .record-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .record-card.expanded .record-content {
            padding: 1.5rem;
            max-height: none;
        }
        
        .field-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.75rem;
            align-items: start;
        }
        
        .field-label {
            font-weight: 600;
            color: #1F4788;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .field-value {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
            word-break: break-word;
            line-height: 1.5;
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #666;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .bms-badge {
            display: inline-block;
            background: #F47920;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 1rem;
        }
        
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .auth-button {
            background: linear-gradient(135deg, #1F4788 0%, #2B73B5 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(31, 71, 136, 0.3);
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-btn {
            background: #F47920;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <h1>BMS Customer Lookup <span class="bms-badge">BMS</span></h1>
            <p style="margin: 1rem 0; color: #666;">Secure access to customer data</p>
            <button id="loginBtn" class="auth-button">Sign In with OKTA</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="header">
            <div class="user-info">
                <span id="userEmail">Loading...</span>
                <button id="logoutBtn" class="logout-btn">Sign Out</button>
            </div>
            <h1>BMS Customer Lookup <span class="bms-badge">BMS</span></h1>
            <p>Customer Data Search Portal</p>
        </div>
    
    <div class="container">
        <div class="search-section">
            <input type="text" id="searchBox" class="search-box" placeholder="Search across all company data and fields...">
            <div id="stats" class="stats">Loading data...</div>
        </div>
        
        <div id="content" class="loading">Loading records from DynamoDB...</div>
    </div>

    <script>
        let currentUser = null;
        let allData = [];
        let filteredData = [];
        
        // Authentication functions
        async function checkAuthState() {
            try {
                // Check for auth code in URL
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (code) {
                    // Exchange code for tokens (simplified)
                    showMainApp();
                    document.getElementById('userEmail').textContent = 'Authenticated User';
                    // Clear URL params
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    // Check if user has valid session
                    const token = localStorage.getItem('cognitoToken');
                    if (token) {
                        showMainApp();
                        document.getElementById('userEmail').textContent = 'Authenticated User';
                    } else {
                        showAuthScreen();
                    }
                }
            } catch (error) {
                showAuthScreen();
            }
        }
        
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            localStorage.removeItem('cognitoToken');
        }
        
        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            localStorage.setItem('cognitoToken', 'authenticated');
            loadData();
        }
        
        // Auth event listeners - OKTA SAML only
        document.getElementById('loginBtn').addEventListener('click', () => {
            window.location.href = 'https://bms-customer-lookup-auth.auth.us-east-1.amazoncognito.com/oauth2/authorize?identity_provider=SAML&client_id=7mck7388jk5brrc602do008kor&response_type=code&scope=email+openid+profile&redirect_uri=' + encodeURIComponent(window.location.origin + '/');
        });
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                // Direct logout to OKTA SAML
                window.location.href = 'https://bms-customer-lookup-auth.auth.us-east-1.amazoncognito.com/logout?client_id=7mck7388jk5brrc602do008kor&logout_uri=' + encodeURIComponent(window.location.origin + '/');
            } catch (error) {
                console.error('Error signing out:', error);
                showAuthScreen();
            }
        });
        
        // Format field names for display
        function formatFieldName(key) {
            return key.replace(/_/g, ' ')
                     .replace(/\b\w/g, l => l.toUpperCase())
                     .replace(/unnamed/gi, 'Field');
        }
        
        // Field mapping for better display
        const fieldMapping = [
            'Company Name',
            'Industry/Type',
            'Address',
            'Key Contacts',
            'Primary Contact',
            'Secondary Contact',
            'Service Type',
            'Region',
            'Territory',
            'Status',
            'Contract Type',
            'Billing Method',
            'Special Requirements',
            'Notes',
            'Authorization Required',
            'Reporting Contact',
            'Daily Report Requirements',
            'Report Frequency',
            'Report Recipient',
            'Escalation Contact',
            'Invoice Processing',
            'Invoice Timeline',
            'Invoice Submission',
            'Invoice Approval',
            'Billing Contact',
            'Payment Method',
            'Payment Contact',
            'Payment Terms',
            'Payment Timeline',
            'Collections Contact',
            'Accounts Payable',
            'AP Contact',
            'Final Invoice Timeline',
            'Invoice Approver',
            'Final Approver',
            'Required Documents',
            'Document Timeline',
            'Document Recipient',
            'Payment Terms Detail',
            'Collection Contact',
            'Collection Method',
            'Collection Timeline',
            'AR Contact',
            'AR Manager',
            'Communication Method',
            'Follow-up Timeline',
            'Final Contact',
            'Final Approver Contact',
            'Documentation Required',
            'Processing Timeline',
            'Final Recipient',
            'Special Instructions'
        ];
        
        // Display records with proper field mapping
        function displayRecords(records) {
            const content = document.getElementById('content');
            
            if (records.length === 0) {
                content.innerHTML = '<div class="no-results">No records found matching your search.</div>';
                return;
            }
            
            const grid = document.createElement('div');
            grid.className = 'records-grid';
            
            records.forEach((record, index) => {
                const card = document.createElement('div');
                card.className = 'record-card';
                
                const companyName = record.original_company || record.company || `Company Record ${index + 1}`;
                
                let fieldsHtml = '';
                
                // Display mapped fields from data array
                if (record.data && Array.isArray(record.data)) {
                    record.data.forEach((value, idx) => {
                        if (value && String(value).trim() !== '' && idx < fieldMapping.length) {
                            fieldsHtml += `
                                <div class="field-label">${fieldMapping[idx]}</div>
                                <div class="field-value">${String(value)}</div>
                            `;
                        }
                    });
                }
                
                // Display other fields
                Object.keys(record).forEach(key => {
                    if (key !== 'data' && key !== 'company') {
                        const value = record[key];
                        if (value !== null && value !== undefined && value !== '') {
                            const displayValue = Array.isArray(value) ? value.join(', ') : String(value);
                            if (displayValue.trim() !== '') {
                                fieldsHtml += `
                                    <div class="field-label">${formatFieldName(key)}</div>
                                    <div class="field-value">${displayValue}</div>
                                `;
                            }
                        }
                    }
                });
                
                card.innerHTML = `
                    <div class="record-header" onclick="toggleCard(this)">
                        ${companyName}
                        <span class="expand-icon">â–¼</span>
                    </div>
                    <div class="record-content">
                        <div class="field-grid">
                            ${fieldsHtml}
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            content.innerHTML = '';
            content.appendChild(grid);
        }
        
        // Update statistics
        function updateStats() {
            const stats = document.getElementById('stats');
            const total = allData.length;
            const filtered = filteredData.length;
            
            if (filtered === total) {
                stats.textContent = `Showing ${total} company records`;
            } else {
                stats.textContent = `Showing ${filtered} of ${total} company records`;
            }
        }
        
        // Toggle card expansion
        function toggleCard(header) {
            const card = header.parentElement;
            card.classList.toggle('expanded');
        }
        
        // Search functionality with direct DynamoDB API call
        async function searchRecords(query) {
            try {
                // Direct API call to Lambda function
                const response = await fetch('https://qs2ihygntwaxmtfwsqjkxkqzx40chslg.lambda-url.us-east-1.on.aws/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Loaded data:', data.length, 'records');
                
                // Filter data based on search query
                let filteredData = data;
                if (query && query.trim()) {
                    const searchTerm = query.toLowerCase();
                    filteredData = data.filter(record => {
                        return Object.values(record).some(value => 
                            value && value.toString().toLowerCase().includes(searchTerm)
                        );
                    });
                }
                
                allData = data;
                filteredData = filteredData;
                displayRecords(filteredData);
                updateStats();
            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('content').innerHTML = 
                    '<div class="no-results">Error loading data: ' + error.message + '</div>';
            }
        }
        
        // Load initial data
        function loadData() {
            searchRecords('');
        }
        
        // Event listeners
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const query = e.target.value;
            searchRecords(query);
        });
        
        // Initialize
        checkAuthState();
    </script>
</body>
</html>
